parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"qMXF":[function(require,module,exports) {
module.exports=(()=>({google:{transport:"session",scope:["https://www.googleapis.com/auth/drive.readonly"],callback:"/drive/callback"},dropbox:{transport:"session",authorize_url:"https://www.dropbox.com/oauth2/authorize",access_url:"https://api.dropbox.com/oauth2/token",callback:"/dropbox/callback"},instagram:{transport:"session",callback:"/instagram/callback"},facebook:{transport:"session",scope:["email","user_photos"],callback:"/facebook/callback"},microsoft:{transport:"session",scope:["files.read.all","offline_access","User.Read"],callback:"/onedrive/callback"}}));
},{}],"oNeJ":[function(require,module,exports) {
class t{constructor(t){return this}static getExtraConfig(){return{}}list(t,e){throw new Error("method not implemented")}download(t,e){throw new Error("method not implemented")}thumbnail(t,e){throw new Error("method not implemented")}size(t,e){throw new Error("method not implemented")}static get authProvider(){return""}}module.exports=t;
},{}],"J3iG":[function(require,module,exports) {
const o=require("chalk");exports.info=((o,e,n)=>{r(o,e,"info",n)}),exports.warn=((e,n,t)=>{r(e,n,"warn",t,o.bold.yellow)}),exports.error=((e,n,t)=>{r(e,n,"error",t,o.bold.red)}),exports.debug=((o,e,n)=>{"production"!==process.env.NODE_ENV&&r(o,e,"debug",n)});const r=(o,r,e,n,t)=>{const s=(new Date).toISOString();n=n||"";const c=(r=r||"")&&n?" ":"";t=t||(o=>o),console.log(t(`companion: ${s} [${e}] ${n}${c}${r}`),t(o))};
},{}],"klSQ":[function(require,module,exports) {
const e=require("mime-types"),t=require("querystring");exports.getUsername=(e=>e.user_email),exports.isFolder=(e=>"folder"===e[".tag"]),exports.getItemSize=(e=>e.size),exports.getItemIcon=(e=>e[".tag"]),exports.getItemSubList=(e=>e.entries),exports.getItemName=(e=>e.name||""),exports.getMimeType=(t=>e.lookup(exports.getItemName(t))||null),exports.getItemId=(e=>e.id),exports.getItemRequestPath=(e=>encodeURIComponent(e.path_lower)),exports.getItemModifiedDate=(e=>e.server_modified),exports.getItemThumbnailUrl=(e=>`/dropbox/thumbnail/${exports.getItemRequestPath(e)}`),exports.getNextPagePath=(e=>{if(!e.has_more)return null;const r={cursor:e.cursor};return`?${t.stringify(r)}`});
},{}],"ZeJU":[function(require,module,exports) {
class r extends Error{constructor(){super("invalid access token detected by Provider"),this.name="AuthError",this.isAuthError=!0}}module.exports=r;
},{}],"tBhl":[function(require,module,exports) {
const e=require("../Provider"),r=require("request"),t=require("purest")({request:r}),o=require("../../logger"),s=require("./adapter"),i=require("../error"),n=/[\u007f-\uffff]/g;function u(e){return JSON.stringify(e).replace(n,function(e){return"\\u"+("000"+e.charCodeAt(0).toString(16)).slice(-4)})}class a extends e{constructor(e){super(e),this.authProvider=e.provider=a.authProvider,this.client=t(e)}static get authProvider(){return"dropbox"}_userInfo({token:e},r){this.client.post("users/get_current_account").options({version:"2"}).auth(e).request(r)}list(e,r){let t,s,i,n=!1,u=!1;const a=()=>{if(i||200!==s.statusCode){const e=this._error(i,s);o.error(e,"provider.dropbox.list.error"),r(e)}else s.body.user_email=t.body.email,r(null,this.adaptData(s.body,e.companion))};this.stats(e,(e,r)=>{u=!0,s=r,i=i||e,n&&a()}),this._userInfo(e,(e,r)=>{n=!0,t=r,i=i||e,u&&a()})}stats({directory:e,query:r,token:t},o){r.cursor?this.client.post("files/list_folder/continue").options({version:"2"}).auth(t).json({cursor:r.cursor}).request(o):this.client.post("files/list_folder").options({version:"2"}).qs(r).auth(t).json({path:`${e||""}`}).request(o)}download({id:e,token:r},t){return this.client.post("https://content.dropboxapi.com/2/files/download").options({version:"2",headers:{"Dropbox-API-Arg":u({path:`${e}`})}}).auth(r).request().on("data",t).on("end",()=>t(null)).on("error",e=>{o.error(e,"provider.dropbox.download.error")})}thumbnail({id:e,token:r},t){return this.client.post("https://content.dropboxapi.com/2/files/get_thumbnail").options({version:"2",headers:{"Dropbox-API-Arg":u({path:`${e}`,size:"w256h256"})}}).auth(r).request().on("response",e=>{if(200!==e.statusCode){const r=this._error(null,e);return o.error(r,"provider.dropbox.thumbnail.error"),t(r)}t(null,e)}).on("error",e=>{o.error(e,"provider.dropbox.thumbnail.error")})}size({id:e,token:r},t){return this.client.post("files/get_metadata").options({version:"2"}).auth(r).json({path:e}).request((e,r,s)=>{if(e||200!==r.statusCode)return e=this._error(e,r),o.error(e,"provider.dropbox.size.error"),t(e);t(null,parseInt(s.size))})}logout({token:e},r){return this.client.post("auth/token/revoke").options({version:"2"}).auth(e).request((e,t)=>{if(e||200!==t.statusCode)return o.error(e,"provider.dropbox.size.error"),void r(this._error(e,t));r(null,{revoked:!0})})}adaptData(e,r){const t={username:s.getUsername(e),items:[]};return s.getItemSubList(e).forEach(e=>{t.items.push({isFolder:s.isFolder(e),icon:s.getItemIcon(e),name:s.getItemName(e),mimeType:s.getMimeType(e),id:s.getItemId(e),thumbnail:r.buildURL(s.getItemThumbnailUrl(e),!0),requestPath:s.getItemRequestPath(e),modifiedDate:s.getItemModifiedDate(e),size:s.getItemSize(e)})}),t.nextPagePath=s.getNextPagePath(e),t}_error(e,r){if(r){const e=`request to ${this.authProvider} returned ${r.statusCode}`;return 401===r.statusCode?new i:new Error(e)}return e}}module.exports=a;
},{"../Provider":"oNeJ","../../logger":"J3iG","./adapter":"klSQ","../error":"ZeJU"}],"b2Lj":[function(require,module,exports) {
function e(e,r){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=t(e))||r&&e&&"number"==typeof e.length){n&&(e=n);var o=0,i=function(){};return{s:i,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(l)throw a}}}}function t(e,t){if(e){if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}const n=require("querystring");exports.getUsername=(t=>{var r,n=e(t.files);try{for(n.s();!(r=n.n()).done;){const t=r.value;if(t.ownedByMe){var o,i=e(t.permissions);try{for(i.s();!(o=i.n()).done;){const e=o.value;if("owner"===e.role)return e.emailAddress}}catch(a){i.e(a)}finally{i.f()}}}}catch(a){n.e(a)}finally{n.f()}}),exports.isFolder=(e=>"application/vnd.google-apps.folder"===e.mimeType||exports.isSharedDrive(e)),exports.getItemSize=(e=>parseInt(e.size,10)),exports.getItemIcon=(e=>{if(exports.isSharedDrive(e)){const t="=w16-h16-n",r=/=[-whncsp0-9]*$/;return e.backgroundImageLink.match(r)?e.backgroundImageLink.replace(r,t):`${e.backgroundImageLink}${t}`}if(e.thumbnailLink){return e.thumbnailLink.replace("s220","s40")}return e.iconLink}),exports.getItemSubList=(e=>e.files.filter(e=>exports.isFolder(e)||!e.mimeType.startsWith("application/vnd.google"))),exports.getItemName=(e=>e.name?e.name:"/"),exports.getMimeType=(e=>e.mimeType),exports.getItemId=(e=>e.id),exports.getItemRequestPath=(e=>e.id),exports.getItemModifiedDate=(e=>e.modifiedTime),exports.getItemThumbnailUrl=(e=>`/drive/thumbnail/${exports.getItemRequestPath(e)}`),exports.isSharedDrive=(e=>"drive#drive"===e.kind),exports.getNextPagePath=((e,t,r)=>{if(!e.nextPageToken)return null;const o=Object.assign({},t,{cursor:e.nextPageToken});return`${r}?${n.stringify(o)}`});
},{}],"bwiw":[function(require,module,exports) {
const e=require("../Provider"),r=require("request"),t=require("purest")({request:r}),i=require("../../logger"),s=require("./adapter"),o=require("../error"),n="kind,id,name,mimeType,ownedByMe,permissions(role,emailAddress),size,modifiedTime,iconLink,thumbnailLink,teamDriveId",d=`kind,nextPageToken,incompleteSearch,files(${n})`,u="*";class a extends e{constructor(e){super(e),this.authProvider=e.provider=a.authProvider,e.alias="drive",e.version="v3",this.client=t(e)}static get authProvider(){return"google"}list(e,r){const t=e.directory||"root",s=e.query||{};let o=Promise.resolve(void 0);"root"===t&&!s.cursor&&(o=new Promise(r=>{this.client.query().get("drives").qs({fields:u}).auth(e.token).request((e,t)=>{e?i.error(e,"provider.drive.sharedDrive.error"):r(t)})}));const n={fields:d,pageToken:s.cursor,q:`'${t}' in parents and trashed=false`,includeItemsFromAllDrives:!0,supportsAllDrives:!0},a=new Promise((r,t)=>{this.client.query().get("files").qs(n).auth(e.token).request((e,i)=>{e||200!==i.statusCode?t(this._error(e,i)):r(i)})});Promise.all([o,a]).then(([i,o])=>{const n=this.adaptData(o.body,i&&i.body,e.companion,t,s);r(null,n)},e=>{i.error(e,"provider.drive.list.error"),r(e)})}stats({id:e,token:r},t){return this.client.query().get(`files/${e}`).qs({fields:n,supportsAllDrives:!0}).auth(r).request(t)}download({id:e,token:r},t){return this.client.query().get(`files/${e}`).qs({alt:"media",supportsAllDrives:!0}).auth(r).request().on("data",t).on("end",()=>t(null)).on("error",e=>{i.error(e,"provider.drive.download.error")})}thumbnail({id:e,token:t},s){return this.stats({id:e,token:t},(e,t,o)=>{if(e||200!==t.statusCode)return e=this._error(e,t),i.error(e,"provider.drive.thumbnail.error"),s(e);s(null,o.thumbnailLink?r(o.thumbnailLink):null)})}size({id:e,token:r},t){return this.stats({id:e,token:r},(e,r,s)=>{if(e||200!==r.statusCode)return e=this._error(e,r),i.error(e,"provider.drive.size.error"),t(e);t(null,parseInt(s.size))})}logout({token:e},r){return this.client.get("https://accounts.google.com/o/oauth2/revoke").qs({token:e}).request((e,t)=>{if(e||200!==t.statusCode)return i.error(e,"provider.drive.logout.error"),void r(this._error(e,t));r(null,{revoked:!0})})}adaptData(e,r,t,i,o){const n=s.getItemSubList(e),d=(r&&r.drives||[]).concat(n).map(e=>({isFolder:s.isFolder(e),icon:s.getItemIcon(e),name:s.getItemName(e),mimeType:s.getMimeType(e),id:s.getItemId(e),thumbnail:t.buildURL(s.getItemThumbnailUrl(e),!0),requestPath:s.getItemRequestPath(e),modifiedDate:s.getItemModifiedDate(e),size:s.getItemSize(e),custom:{isTeamDrive:s.isSharedDrive(e),isSharedDrive:s.isSharedDrive(e)}}));return{username:s.getUsername(e),items:d,nextPagePath:s.getNextPagePath(e,o,i)}}_error(e,r){if(r){const e=`request to ${this.authProvider} returned ${r.statusCode}`;return 401===r.statusCode?new o:new Error(e)}return e}}module.exports=a;
},{"../Provider":"oNeJ","../../logger":"J3iG","./adapter":"b2Lj","../error":"ZeJU"}],"VHJa":[function(require,module,exports) {
const e=require("request"),t=require("crypto");function r(e){const r=t.createHash("sha256");return r.update(e),r.digest()}function n(){return t.randomBytes(16)}function s(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"~")}function o(e){return e=e.replace(/-/g,"+").replace(/_/g,"/").replace(/~/g,"=")}exports.hasMatch=((e,t)=>t.some(t=>e===t||new RegExp(t).test(e))),exports.jsonStringify=(e=>{const t=[];return JSON.stringify(e,(e,r)=>{if("object"==typeof r&&null!==r){if(-1!==t.indexOf(r))return;t.push(r)}return r})}),exports.sanitizeHtml=(e=>e?e.replace(/<\/?[^>]+(>|$)/g,""):e),exports.getURLMeta=(t=>new Promise((r,n)=>{e({uri:t,method:"HEAD",followAllRedirects:!0},(e,t,s)=>{e?n(e):r({type:t.headers["content-type"],size:parseInt(t.headers["content-length"])})})})),module.exports.getURLBuilder=(e=>{return(t,r,n)=>{let s=t;return r&&(s=`${e.server.implicitPath||""}${s}`),s=`${e.server.path||""}${s}`,n||(s=`${e.server.protocol}://${e.server.host}${s}`),s}}),module.exports.encrypt=((e,o)=>{const a=n(),i=t.createCipheriv("aes256",r(o),a);let c=i.update(e,"utf8","base64");return c+=i.final("base64"),a.toString("hex")+s(c)}),module.exports.decrypt=((e,n)=>{if(e.length<32)throw new Error("Invalid encrypted value. Maybe it was generated with an old Companion version?");const s=Buffer.from(e.slice(0,32),"hex"),a=e.slice(32),i=t.createDecipheriv("aes256",r(n),s);let c=i.update(o(a),"base64","utf8");return c+=i.final("utf8")});
},{}],"v3Tq":[function(require,module,exports) {
exports.isFolder=(e=>!1),exports.getItemIcon=(e=>e.images?e.images.low_resolution.url:"video"),exports.getItemSubList=(e=>{const t=[];return e.data.forEach(e=>{e.carousel_media?e.carousel_media.forEach((r,i)=>{const o=Object.assign({},r,{id:e.id,created_time:e.created_time,carousel_id:i});t.push(o)}):t.push(e)}),t}),exports.getItemName=(e=>{if(e&&e.created_time){const t="video"===e.type?"mp4":"jpeg";return`Instagram ${new Date(1e3*e.created_time).toLocaleDateString([],{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})}${e.carousel_id?" "+e.carousel_id:""}.${t}`}return""}),exports.getMimeType=(e=>"video"===e.type?"video/mp4":"image/jpeg"),exports.getItemId=(e=>`${e.id}${e.carousel_id||""}`),exports.getItemRequestPath=(e=>{const t=isNaN(e.carousel_id)?"":`?carousel_id=${e.carousel_id}`;return`${e.id}${t}`}),exports.getItemModifiedDate=(e=>e.created_time),exports.getItemThumbnailUrl=(e=>e.images?e.images.thumbnail.url:null),exports.getNextPagePath=(e=>{const t=exports.getItemSubList(e);if(t.length)return`recent?cursor=${exports.getItemId(t[t.length-1])}`});
},{}],"mX9i":[function(require,module,exports) {
const e=require("../Provider"),r=require("request"),t=require("purest")({request:r}),a=require("../../helpers/utils"),i=require("../../logger"),s=require("./adapter"),o=require("../error");class u extends e{constructor(e){super(e),this.authProvider=e.provider=u.authProvider,this.client=t(e)}static get authProvider(){return"instagram"}list({directory:e="recent",token:r,query:t={}},a){const s=t.cursor||t.max_id,o=s?{max_id:s}:{};this.client.get(`users/self/media/${e}`).qs(o).auth(r).request((e,t,s)=>{if(e||200!==t.statusCode)return e=this._error(e,t),i.error(e,"provider.instagram.list.error"),a(e);this._getUsername(r,(e,r)=>{e?a(e):a(null,this.adaptData(s,r))})})}_getUsername(e,r){this.client.get("users/self").auth(e).request((e,t,a)=>{if(e||200!==t.statusCode)return e=this._error(e,t),i.error(e,"provider.instagram.user.error"),r(e);r(null,a.data.username)})}_getMediaUrl(e,r){let t,a;return"carousel"===e.data.type?(r=r?parseInt(r):0,a=(t=e.data.carousel_media[r]).type):(t=e.data,a=e.data.type),t[`${a}s`].standard_resolution.url}download({id:e,token:t,query:a={}},s){return this.client.get(`media/${e}`).auth(t).request((e,t,o)=>{if(e)return i.error(e,"provider.instagram.download.error");r(this._getMediaUrl(o,a.carousel_id)).on("data",s).on("end",()=>s(null)).on("error",e=>{i.error(e,"provider.instagram.download.url.error")})})}thumbnail(e,r){const t=new Error("call to thumbnail is not implemented");return i.error(t,"provider.instagram.thumbnail.error"),r(t)}size({id:e,token:r,query:t={}},s){return this.client.get(`media/${e}`).auth(r).request((e,r,o)=>{if(e||200!==r.statusCode)return e=this._error(e,r),i.error(e,"provider.instagram.size.error"),s(e);a.getURLMeta(this._getMediaUrl(o,t.carousel_id)).then(({size:e})=>s(null,e)).catch(e=>{i.error(e,"provider.instagram.size.error"),s()})})}logout(e,r){r(null,{revoked:!1,manual_revoke_url:"https://www.instagram.com/accounts/manage_access/"})}adaptData(e,r){const t={username:r,items:[]};return s.getItemSubList(e).forEach(e=>{t.items.push({isFolder:s.isFolder(e),icon:s.getItemIcon(e),name:s.getItemName(e),mimeType:s.getMimeType(e),id:s.getItemId(e),thumbnail:s.getItemThumbnailUrl(e),requestPath:s.getItemRequestPath(e),modifiedDate:s.getItemModifiedDate(e)})}),t.nextPagePath=s.getNextPagePath(e),t}_error(e,r){return r?400===r.statusCode&&r.body&&"OAuthAccessTokenException"===r.body.meta.error_type?new o:new Error(`request to ${this.authProvider} returned ${r.statusCode}`):e}}module.exports=u;
},{"../Provider":"oNeJ","../../helpers/utils":"VHJa","../../logger":"J3iG","./adapter":"v3Tq","../error":"ZeJU"}],"Fb03":[function(require,module,exports) {
const e=require("querystring"),t=Object.freeze({video:"VIDEO",carousel:"CAROUSEL_ALBUM",image:"IMAGE"}),r=e=>e.media_type===t.video;exports.isFolder=(e=>!1),exports.getItemIcon=(e=>r(e)?e.thumbnail_url:e.media_url),exports.getItemSubList=(e=>{const s=[];return e.data.forEach(e=>{r(e)||(e.media_type===t.carousel?e.children.data.forEach(e=>{r(e)||s.push(e)}):s.push(e))}),s}),exports.getItemName=((e,t)=>{const s=r(e)?"mp4":"jpeg";return`Instagram ${e.timestamp}${t}.${s}`}),exports.getMimeType=(e=>r(e)?"video/mp4":"image/jpeg"),exports.getItemId=(e=>e.id),exports.getItemRequestPath=(e=>e.id),exports.getItemModifiedDate=(e=>e.timestamp),exports.getItemThumbnailUrl=(e=>exports.getItemIcon(e)),exports.getNextPagePath=((t,r,s)=>{if(!t.paging||!t.paging.cursors)return null;const a=Object.assign({},r,{cursor:t.paging.cursors.after});return`${s||""}?${e.stringify(a)}`});
},{}],"FLpq":[function(require,module,exports) {
const r=require("../../Provider"),e=require("request"),t=require("purest")({request:e}),i=require("../../../helpers/utils"),a=require("../../../logger"),s=require("./adapter"),o=require("../../error");class u extends r{constructor(r){super(r),this.authProvider=r.provider=u.authProvider,this.client=t(r)}static getExtraConfig(){return{protocol:"https",scope:["user_profile","user_media"]}}static get authProvider(){return"instagram"}list({directory:r,token:e,query:t={}},i){const s={fields:"id,media_type,thumbnail_url,media_url,timestamp,children{media_type,media_url,thumbnail_url,timestamp}"};t.cursor&&(s.after=t.cursor),this.client.get("https://graph.instagram.com/me/media").qs(s).auth(e).request((s,o,u)=>{if(s||200!==o.statusCode)return s=this._error(s,o),a.error(s,"provider.instagram.list.error"),i(s);this._getUsername(e,(e,a)=>{e?i(e):i(null,this.adaptData(u,a,r,t))})})}_getUsername(r,e){this.client.get("https://graph.instagram.com/me").qs({fields:"username"}).auth(r).request((r,t,i)=>{if(r||200!==t.statusCode)return r=this._error(r,t),a.error(r,"provider.instagram.user.error"),e(r);e(null,i.username)})}download({id:r,token:t},i){return this.client.get(`https://graph.instagram.com/${r}`).qs({fields:"media_url"}).auth(t).request((r,t,s)=>{if(r)return a.error(r,"provider.instagram.download.error");e(s.media_url).on("data",i).on("end",()=>i(null)).on("error",r=>{a.error(r,"provider.instagram.download.url.error")})})}thumbnail(r,e){const t=new Error("call to thumbnail is not implemented");return a.error(t,"provider.instagram.thumbnail.error"),e(t)}size({id:r,token:e},t){return this.client.get(`https://graph.instagram.com/${r}`).qs({fields:"media_url"}).auth(e).request((r,e,s)=>{if(r||200!==e.statusCode)return r=this._error(r,e),a.error(r,"provider.instagram.size.error"),t(r);i.getURLMeta(s.media_url).then(({size:r})=>t(null,r)).catch(r=>{a.error(r,"provider.instagram.size.error"),t()})})}logout(r,e){e(null,{revoked:!1,manual_revoke_url:"https://www.instagram.com/accounts/manage_access/"})}adaptData(r,e,t,i){const a={username:e,items:[]};return s.getItemSubList(r).forEach((r,e)=>{a.items.push({isFolder:s.isFolder(r),icon:s.getItemIcon(r),name:s.getItemName(r,e),mimeType:s.getMimeType(r),id:s.getItemId(r),thumbnail:s.getItemThumbnailUrl(r),requestPath:s.getItemRequestPath(r),modifiedDate:s.getItemModifiedDate(r)})}),a.nextPagePath=s.getNextPagePath(r,i,t),a}_error(r,e){if(e){if(e.body&&190===e.body.error.code)return new o;const r=e.body&&e.body.error?e.body.error.message:"";return new Error(`request to ${this.authProvider} returned status: ${e.statusCode}, message: ${r}`)}return r}}module.exports=u;
},{"../../Provider":"oNeJ","../../../helpers/utils":"VHJa","../../../logger":"J3iG","./adapter":"Fb03","../../error":"ZeJU"}],"ocoX":[function(require,module,exports) {
const e=require("querystring");exports.isFolder=(e=>!!e.type),exports.getItemIcon=(e=>exports.isFolder(e)?"folder":exports.sortImages(e.images)[0].source),exports.getItemSubList=(e=>e.data),exports.getItemName=(e=>e.name||`${e.id} ${e.created_time}`),exports.getMimeType=(e=>exports.isFolder(e)?null:"image/jpeg"),exports.getItemId=(e=>`${e.id}`),exports.getItemRequestPath=(e=>`${e.id}`),exports.getItemModifiedDate=(e=>e.created_time),exports.getItemThumbnailUrl=(e=>exports.isFolder(e)?null:exports.sortImages(e.images)[0].source),exports.getNextPagePath=((t,r,s)=>{if(!t.paging||!t.paging.cursors)return null;const o=Object.assign({},r,{cursor:t.paging.cursors.after});return`${s||""}?${e.stringify(o)}`}),exports.sortImages=(e=>e.slice().sort((e,t)=>e.width-t.width));
},{}],"yAZM":[function(require,module,exports) {
const e=require("../Provider"),r=require("request"),t=require("purest")({request:r}),o=require("../../helpers/utils"),i=require("../../logger"),s=require("./adapter"),a=require("../error");class u extends e{constructor(e){super(e),this.authProvider=e.provider=u.authProvider,this.client=t(e)}static get authProvider(){return"facebook"}list({directory:e,token:r,query:t={}},o){const s={fields:"name,cover_photo,created_time,type"};t.cursor&&(s.after=t.cursor);let a="me/albums";e&&(a=`${e}/photos`,s.fields="icon,images,name,width,height,created_time"),this.client.get(a).qs(s).auth(r).request((s,a,u)=>{if(s||200!==a.statusCode)return s=this._error(s,a),i.error(s,"provider.facebook.list.error"),o(s);this._getUsername(r,(r,i)=>{r?o(r):o(null,this.adaptData(u,i,e,t))})})}_getUsername(e,r){this.client.get("me").qs({fields:"email"}).auth(e).request((e,t,o)=>{if(e||200!==t.statusCode)return e=this._error(e,t),i.error(e,"provider.facebook.user.error"),r(e);r(null,o.email)})}_getMediaUrl(e){const r=s.sortImages(e.images);return r[r.length-1].source}download({id:e,token:t},o){return this.client.get(e).qs({fields:"images"}).auth(t).request((e,t,s)=>{if(e)return i.error(e,"provider.facebook.download.error");r(this._getMediaUrl(s)).on("data",o).on("end",()=>o(null)).on("error",e=>{i.error(e,"provider.facebook.download.url.error")})})}thumbnail(e,r){const t=new Error("call to thumbnail is not implemented");return i.error(t,"provider.facebook.thumbnail.error"),r(t)}size({id:e,token:r},t){return this.client.get(e).qs({fields:"images"}).auth(r).request((e,r,s)=>{if(e||200!==r.statusCode)return e=this._error(e,r),i.error(e,"provider.facebook.size.error"),t(e);o.getURLMeta(this._getMediaUrl(s)).then(({size:e})=>t(null,e)).catch(e=>{i.error(e,"provider.facebook.size.error"),t()})})}logout({token:e},r){return this.client.delete("me/permissions").auth(e).request((e,t)=>{if(e||200!==t.statusCode)return i.error(e,"provider.facebook.logout.error"),void r(this._error(e,t));r(null,{revoked:!0})})}adaptData(e,r,t,o){const i={username:r,items:[]};return s.getItemSubList(e).forEach(e=>{i.items.push({isFolder:s.isFolder(e),icon:s.getItemIcon(e),name:s.getItemName(e),mimeType:s.getMimeType(e),id:s.getItemId(e),thumbnail:s.getItemThumbnailUrl(e),requestPath:s.getItemRequestPath(e),modifiedDate:s.getItemModifiedDate(e)})}),i.nextPagePath=s.getNextPagePath(e,o,t),i}_error(e,r){if(r){if(r.body&&190===r.body.error.code)return new a;const e=r.body&&r.body.error?r.body.error.message:"";return new Error(`request to ${this.authProvider} returned status: ${r.statusCode}, message: ${e}`)}return e}}module.exports=u;
},{"../Provider":"oNeJ","../../helpers/utils":"VHJa","../../logger":"J3iG","./adapter":"ocoX","../error":"ZeJU"}],"NgyI":[function(require,module,exports) {
const e=require("querystring");exports.isFolder=(e=>e.remoteItem?!!e.remoteItem.folder:!!e.folder),exports.getItemSize=(e=>e.size),exports.getItemIcon=(e=>exports.isFolder(e)?"folder":exports.getItemThumbnailUrl(e)),exports.getItemSubList=(e=>e.value),exports.getItemName=(e=>e.name||""),exports.getMimeType=(e=>e.file?e.file.mimeType:null),exports.getItemId=(e=>e.remoteItem?e.remoteItem.id:e.id),exports.getItemRequestPath=(e=>{let t=`?driveId=${e.parentReference.driveId}`;return e.remoteItem&&(t=`?driveId=${e.remoteItem.parentReference.driveId}`),exports.getItemId(e)+t}),exports.getItemModifiedDate=(e=>e.lastModifiedDateTime),exports.getItemThumbnailUrl=(e=>e.thumbnails[0]?e.thumbnails[0].medium.url:null),exports.getNextPagePath=(t=>{if(!t["@odata.nextLink"])return null;const r={cursor:e.parse(t["@odata.nextLink"]).$skiptoken};return`?${e.stringify(r)}`});
},{}],"cVbC":[function(require,module,exports) {
const e=require("../Provider"),r=require("request"),t=require("purest")({request:r}),i=require("../../logger"),o=require("./adapter"),s=require("../error");class n extends e{constructor(e){super(e),this.authProvider=e.provider=n.authProvider,this.client=t(e)}static get authProvider(){return"microsoft"}_userInfo({token:e},r){this.client.get("me").auth(e).request(r)}list({directory:e,query:r,token:t},o){const s=e?`items/${e}`:"root",n=r.driveId?`/drives/${r.driveId}`:"/drive",u={$expand:"thumbnails"};r.cursor&&(u.$skiptoken=r.cursor),this.client.get(`${n}/${s}/children`).qs(u).auth(t).request((e,r,s)=>{if(e||200!==r.statusCode)return e=this._error(e,r),i.error(e,"provider.onedrive.list.error"),o(e);this._userInfo({token:t},(e,r)=>{if(e||200!==r.statusCode)return e=this._error(e,r),i.error(e,"provider.onedrive.user.error"),o(e);o(null,this.adaptData(s,r.body.mail||r.body.userPrincipalName))})})}download({id:e,token:r,query:t},o){const s=t.driveId?`/drives/${t.driveId}`:"/drive";return this.client.get(`${s}/items/${e}/content`).auth(r).request().on("data",o).on("end",()=>o(null)).on("error",e=>{i.error(e,"provider.onedrive.download.error")})}thumbnail(e,r){const t=new Error("call to thumbnail is not implemented");return i.error(t,"provider.onedrive.thumbnail.error"),r(t)}size({id:e,query:r,token:t},o){const s=r.driveId?`/drives/${r.driveId}`:"/drive";return this.client.get(`${s}/items/${e}`).auth(t).request((e,r,t)=>{if(e||200!==r.statusCode)return e=this._error(e,r),i.error(e,"provider.onedrive.size.error"),o(e);o(null,t.size)})}logout(e,r){r(null,{revoked:!1,manual_revoke_url:"https://account.live.com/consent/Manage"})}adaptData(e,r){const t={username:r,items:[]};return o.getItemSubList(e).forEach(e=>{t.items.push({isFolder:o.isFolder(e),icon:o.getItemIcon(e),name:o.getItemName(e),mimeType:o.getMimeType(e),id:o.getItemId(e),thumbnail:o.getItemThumbnailUrl(e),requestPath:o.getItemRequestPath(e),modifiedDate:o.getItemModifiedDate(e),size:o.getItemSize(e)})}),t.nextPagePath=o.getNextPagePath(e),t}_error(e,r){if(r){const e=`request to ${this.authProvider} returned ${r.statusCode}`;return 401===r.statusCode?new s:new Error(e)}return e}}module.exports=n;
},{"../Provider":"oNeJ","../../logger":"J3iG","./adapter":"NgyI","../error":"ZeJU"}],"szpj":[function(require,module,exports) {
const e=require("@purest/providers"),r=require("./dropbox"),o=require("./drive"),i=require("./instagram"),t=require("./instagram/graph"),d=require("./facebook"),s=require("./onedrive"),a=require("../helpers/utils"),n=a.getURLBuilder,p=require("../logger"),l=require("./Provider");module.exports.getProviderMiddleware=(r=>{return(o,i,t,d)=>{r[d]&&v(o.companion.options)?o.companion.provider=new r[d]({providerName:d,config:e}):p.warn("invalid provider options detected. Provider will not be loaded","provider.middleware.invalid",o.id),t()}}),module.exports.getDefaultProviders=(e=>{const a=(e||{providerOptions:null}).providerOptions,n={dropbox:r,drive:o,facebook:d,onedrive:s};return a&&a.instagram&&(()=>/^\d+$/.test(a.instagram.key))()?n.instagram=t:n.instagram=i,n}),module.exports.addCustomProviders=((e,r,o)=>{Object.keys(e).forEach(i=>{r[i]=e[i].module,o[i]=e[i].config})}),module.exports.addProviderOptions=((e,r)=>{const o=e.server,i=e.providerOptions;if(!v({server:o}))return void p.warn("invalid provider options detected. Providers will not be loaded","provider.options.invalid");r.defaults={host:o.host,protocol:o.protocol,path:o.path};const t=o.oauthDomain;Object.keys(i).filter(e=>"server"!==e).forEach(d=>{if(r[d]){r[d].key=i[d].key,r[d].secret=i[d].secret;const s=c(d,e),a=s.provider,p=s.name;if(Object.assign(r[d],a.getExtraConfig()),t){const i=`/${p}/redirect`,s=!!o.implicitPath,a=n(e)(i,s,!0);r[d].redirect_uri=`${o.protocol}://${t}${a}`}o.implicitPath?r[d].callback=`${o.implicitPath}${r[d].callback}`:o.path&&(r[d].callback=`${o.path}${r[d].callback}`)}else"s3"!==d&&"b2"!==d&&p.warn(`skipping one found unsupported provider "${d}".`,"provider.options.skip")})});const c=(e,r)=>{const o=exports.getDefaultProviders(r);for(var i=0,t=Object.keys(o);i<t.length;i++){const r=t[i],d=o[r];if(d.authProvider===e)return{name:r,provider:d}}},v=e=>e.server.host&&e.server.protocol;
},{"./dropbox":"tBhl","./drive":"bwiw","./instagram":"mX9i","./instagram/graph":"FLpq","./facebook":"yAZM","./onedrive":"cVbC","../helpers/utils":"VHJa","../logger":"J3iG","./Provider":"oNeJ"}],"tnRk":[function(require,module,exports) {
const e=require("jsonwebtoken"),o=require("./utils"),r=o.encrypt,t=o.decrypt;module.exports.generateToken=((o,t)=>r(e.sign({data:o},t,{expiresIn:86400}),t)),module.exports.verifyToken=((o,r)=>{try{return{payload:e.verify(t(o,r),r,{}).data}}catch(n){return{err:n}}}),module.exports.addToCookies=((e,o,r,t)=>{const n={maxAge:2592e6,httpOnly:!0};r.cookieDomain&&(n.domain=r.cookieDomain),e.cookie(`uppyAuthToken--${t}`,o,n)}),module.exports.removeFromCookies=((e,o,r)=>{const t={maxAge:2592e6,httpOnly:!0};o.cookieDomain&&(t.domain=o.cookieDomain),e.clearCookie(`uppyAuthToken--${r}`,t)});
},{"./utils":"VHJa"}],"uLtQ":[function(require,module,exports) {
const e=require("../helpers/jwt"),o=require("../logger");module.exports=function(n,r,s){const i=n.params.providerName;if(n.companion.providerTokens||(n.companion.providerTokens={}),n.session.grant.response.access_token){n.companion.providerTokens[i]=n.session.grant.response.access_token,o.debug(`Generating auth token for provider ${i}`,null,n.id);const s=e.generateToken(n.companion.providerTokens,n.companion.options.secret);return r.redirect(n.companion.buildURL(`/${i}/send-token?uppyAuthToken=${s}`,!0))}return o.debug(`Did not receive access token for provider ${i}`,null,n.id),o.debug(n.session.grant.response,"callback.oauth.resp",n.id),r.sendStatus(400)};
},{"../helpers/jwt":"tnRk","../logger":"J3iG"}],"ONoK":[function(require,module,exports) {
const t=require("./utils"),e=t.encrypt,r=t.decrypt,o=require("crypto"),n=require("atob");module.exports.generateState=(t=>{const e={};return e.id=o.randomBytes(10).toString("hex"),s(e,t)}),module.exports.addToState=((t,e,r)=>{const o=u(t,r);return s(Object.assign(o,e),r)}),module.exports.getFromState=((t,e,r)=>u(t,r)[e]);const s=(t,r)=>{const o=Buffer.from(JSON.stringify(t)).toString("base64");return e(o,r)},u=(t,e)=>{const o=r(t,e);return JSON.parse(n(o))};
},{"./utils":"VHJa"}],"iEqF":[function(require,module,exports) {
const e=require("semver");exports.gte=((r,o)=>(r=e.coerce(r).version,o=e.coerce(o).version,e.gte(r,o)));
},{}],"rH3w":[function(require,module,exports) {
const n=require("../helpers/jwt"),e=require("url").parse,o=require("../helpers/utils"),t=o.hasMatch,s=o.sanitizeHtml,i=require("../helpers/oauth-state"),r=require("../helpers/version");module.exports=function(o,s,p){const h=o.companion.authToken;n.addToCookies(s,h,o.companion.options,o.companion.provider.authProvider);const d=((o.session.grant||{}).dynamic||{}).state;if(d){const n=i.getFromState(d,"origin",o.companion.options.secret),p=i.getFromState(d,"clientVersion",o.companion.options.secret),m=o.companion.options.clients;if(!m||t(n,m)||t(e(n).host,m)){const e=r.gte(p,"1.0.2");return s.send(e?a(h,n):c(h,n))}}p()};const a=(n,e)=>`\n    <!DOCTYPE html>\n    <html>\n    <head>\n        <meta charset="utf-8" />\n        <script>\n          window.opener.postMessage(JSON.stringify({token: "${n}"}), "${s(e)}")\n          window.close()\n        <\/script>\n    </head>\n    <body></body>\n    </html>`,c=(n,e)=>`\n    <!DOCTYPE html>\n    <html>\n    <head>\n        <meta charset="utf-8" />\n        <script>\n          window.opener.postMessage({token: "${n}"}, "${s(e)}")\n          window.close()\n        <\/script>\n    </head>\n    <body></body>\n    </html>`;
},{"../helpers/jwt":"tnRk","../helpers/utils":"VHJa","../helpers/oauth-state":"ONoK","../helpers/version":"iEqF"}],"Dt2q":[function(require,module,exports) {
const e=require("events").EventEmitter;module.exports=(()=>new e);
},{}],"nC3e":[function(require,module,exports) {
const e=require("node-redis-pubsub");class r extends e{constructor(e){super({url:e})}once(e,r){const s=this.on(e,e=>{r(e),s()})}emit(e,r){return super.emit(e,r||{})}removeListener(e,r){this.receiver.removeListener(e,r),this.receiver.punsubscribe(this.prefix+e)}removeAllListeners(e){this.receiver.removeAllListeners(e),this.receiver.punsubscribe(this.prefix+e)}}module.exports=(e=>new r(e));
},{}],"AtwR":[function(require,module,exports) {
const e=require("./default-emitter"),r=require("./redis-emitter");let t;module.exports=(i=>(t||(t=i?r(i):e()),t));
},{"./default-emitter":"Dt2q","./redis-emitter":"nC3e"}],"uoOB":[function(require,module,exports) {
const e=require("isobject"),r=require("./logger"),t=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","date","dnt","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],o=[/^proxy-.*$/,/^sec-.*$/],n=e=>{const n=e.toLowerCase(),c=t.indexOf(n)>=0||o.findIndex(e=>e.test(n))>=0;return c&&r.warn(`Header forbidden: ${e}`,"header.forbidden"),c};module.exports=(r=>{if(!e(r))return{};const t=Object.assign({},r);return Object.keys(t).forEach(e=>{n(e)&&delete t[e]}),t});
},{"./logger":"J3iG"}],"jBoH":[function(require,module,exports) {
const e=require("redis");let t;module.exports.client=(r=>r?(t||(t=e.createClient(r)),t):t);
},{}],"IfnG":[function(require,module,exports) {
const t=require("fs"),e=require("path"),s=require("tus-js-client"),i=require("uuid"),o=require("@uppy/fs-tail-stream"),r=require("./emitter"),a=require("request"),n=require("serialize-error"),p=require("./helpers/utils"),l=p.jsonStringify,h=p.hasMatch,u=require("./logger"),d=require("validator"),c=require("./header-blacklist"),m=require("./redis"),g=Object.freeze({multipart:"multipart",s3Multipart:"s3-multipart",b2Multipart:"b2-multipart",tus:"tus"});class b{constructor(s){this.validateOptions(s)?(this.options=s,this.token=i.v4(),this.path=`${this.options.pathPrefix}/${b.FILE_NAME_PREFIX}-${this.token}`,this.options.metadata=this.options.metadata||{},this.uploadFileName=this.options.metadata.name||e.basename(this.path),this.streamsEnded=!1,this.uploadStopped=!1,this.duplexStream=null,this.writeStream=t.createWriteStream(this.path,{mode:438}).on("error",t=>u.error(`${t}`,"uploader.write.error",this.shortToken)),this.emittedProgress=0,this.storage=s.storage,this._paused=!1,this.options.protocol===g.tus&&(r().on(`pause:${this.token}`,()=>{this._paused=!0,this.tus&&this.tus.abort()}),r().on(`resume:${this.token}`,()=>{this._paused=!1,this.tus&&this.tus.start()}),r().on(`cancel:${this.token}`,()=>{if(this._paused=!0,this.tus){const t=!!this.tus.url;this.tus.abort(t)}this.cleanUp()}))):u.debug(this._errRespMessage,"uploader.validator.fail")}static shortenToken(t){return t.substring(0,8)}static reqToOptions(t,e){return{companionOptions:t.companion.options,endpoint:t.body.endpoint,uploadUrl:t.body.uploadUrl,protocol:t.body.protocol,metadata:t.body.metadata,httpMethod:t.body.httpMethod,size:e,fieldname:t.body.fieldname,pathPrefix:`${t.companion.options.filePath}`,storage:m.client(),s3:t.companion.s3Client?{client:t.companion.s3Client,options:t.companion.options.providerOptions.s3}:null,b2:t.uppy.b2Client?{client:t.uppy.b2Client,options:t.uppy.options.providerOptions.b2}:null,headers:t.body.headers}}get bytesWritten(){return this.writeStream.bytesWritten}validateOptions(t){if(t.protocol===g.s3Multipart||t.protocol===g.b2Multipart)return!0;if(!t.endpoint&&!t.uploadUrl)return this._errRespMessage="No destination specified",!1;const e={require_protocol:!0,require_tld:!t.companionOptions.debug};return[t.endpoint,t.uploadUrl].every(s=>{if(s&&!d.isURL(s,e))return this._errRespMessage="Invalid destination url",!1;const i=t.companionOptions.uploadUrls;return!(i&&s&&!h(s,i))||(this._errRespMessage="upload destination does not match any allowed destinations",!1)})}hasError(){return null!=this._errRespMessage}get shortToken(){return b.shortenToken(this.token)}onSocketReady(t){r().once(`connection:${this.token}`,()=>t()),u.debug("waiting for connection","uploader.socket.wait",this.shortToken)}cleanUp(){t.unlink(this.path,t=>{t&&u.error(`cleanup failed for: ${this.path} err: ${t}`,"uploader.cleanup.error")}),r().removeAllListeners(`pause:${this.token}`),r().removeAllListeners(`resume:${this.token}`),r().removeAllListeners(`cancel:${this.token}`),this.uploadStopped=!0}handleChunk(t){if(this.uploadStopped)return;const e=this.options.protocol||g.multipart;if(null===t)return this.writeStream.on("finish",()=>{if(this.streamsEnded=!0,this.options.endpoint&&e===g.multipart&&this.uploadMultipart(),e===g.tus&&!this.tus)return this.uploadTus()}),this.endStreams();this.writeStream.write(t,()=>e===g.multipart||e===g.tus?this.emitIllusiveProgress():e!==g.s3Multipart||this.s3Upload?e!==g.b2Multipart||this.b2Upload?void 0:this.uploadB2():this.uploadS3Multipart())}writeToStreams(t,e){const s=[],i=this.duplexStream?2:1,o=()=>{s.push(!0),s.length>=i&&e()};this.writeStream.write(t,o),this.duplexStream&&this.duplexStream.write(t,o)}endStreams(){this.writeStream.end(),this.duplexStream&&this.duplexStream.end()}getResponse(){return this._errRespMessage?{body:this._errRespMessage,status:400}:{body:{token:this.token},status:200}}saveState(t){this.storage&&this.storage.set(`${b.STORAGE_PREFIX}:${this.token}`,l(t))}emitIllusiveProgress(t=0){if(this._paused)return;let e=this.streamsEnded?this.bytesWritten:this.options.size;this.streamsEnded||(e=Math.max(e,this.bytesWritten));const s=this.bytesWritten/2+t/2;u.debug(`${t} ${s} ${e}`,"uploader.illusive.progress",this.shortToken),this.emitProgress(s,e)}emitProgress(t,e){e=e||this.options.size,this.tus&&this.tus.options.uploadLengthDeferred&&this.streamsEnded&&(e=this.bytesWritten);const s=t/e*100,i=s.toFixed(2);u.debug(`${t} ${e} ${i}%`,"uploader.upload.progress",this.shortToken);const o={action:"progress",payload:{progress:i,bytesUploaded:t,bytesTotal:e}};this.saveState(o);const a=Math.floor(s);this.emittedProgress!==a&&(this.emittedProgress=a,r().emit(this.token,o))}emitSuccess(t,e={}){const s={action:"success",payload:Object.assign(e,{complete:!0,url:t})};this.saveState(s),r().emit(this.token,s)}emitError(t,e={}){const s=n(t);delete s.stack;const i={action:"error",payload:Object.assign(e,{error:s})};this.saveState(i),r().emit(this.token,i)}uploadTus(){const e=t.createReadStream(this.path),i=this;this.tus=new s.Upload(e,{endpoint:this.options.endpoint,uploadUrl:this.options.uploadUrl,uploadLengthDeferred:!1,resume:!0,retryDelays:[0,1e3,3e3,5e3],uploadSize:this.bytesWritten,metadata:Object.assign({filename:this.uploadFileName,filetype:this.options.metadata.type},this.options.metadata),onError(t){u.error(t,"uploader.tus.error"),i.emitError(t)},onProgress(t,e){i.emitIllusiveProgress(t)},onSuccess(){i.emitSuccess(i.tus.url),i.cleanUp()}}),this._paused||this.tus.start()}uploadMultipart(){const e=t.createReadStream(this.path);let s=0;e.on("data",t=>{s+=t.length,this.emitIllusiveProgress(s)});const i=Object.assign({},this.options.metadata,{[this.options.fieldname]:{value:e,options:{filename:this.uploadFileName,contentType:this.options.metadata.type}}}),o="put"===(this.options.httpMethod||"").toLowerCase()?"put":"post",r=c(this.options.headers);a[o]({url:this.options.endpoint,headers:r,formData:i,encoding:null},(t,e,i)=>{if(t)return u.error(t,"upload.multipart.error"),void this.emitError(t);const o=e.headers;delete o["set-cookie"],delete o["set-cookie2"];const r={responseText:i.toString(),status:e.statusCode,statusText:e.statusMessage,headers:o};if(e.statusCode>=400)u.error(`upload failed with status: ${e.statusCode}`,"upload.multipart.error"),this.emitError(new Error(e.statusMessage),r);else if(s!==this.bytesWritten&&s!==this.options.size){const t=`uploaded only ${s} of ${this.bytesWritten} with status: ${e.statusCode}`;u.error(t,"upload.multipart.mismatch.error"),this.emitError(new Error(t))}else this.emitSuccess(null,{response:r});this.cleanUp()})}beginTailReadStream(){const t=o(this.path,{tail:!0});return this.writeStream.on("finish",()=>{t.close()}),t}uploadS3Multipart(){const t=this.beginTailReadStream();return this._uploadS3MultipartStream(t)}_uploadS3MultipartStream(t){if(!this.options.s3)return void this.emitError(new Error("The S3 client is not configured on this companion instance."));const s=this.options.metadata.name||e.basename(this.path),i=this.options.s3,o=i.client,r=i.options,a=o.upload({Bucket:r.bucket,Key:r.getKey(null,s,this.options.metadata),ACL:r.acl,ContentType:this.options.metadata.type,Body:t});this.s3Upload=a,a.on("httpUploadProgress",({loaded:t,total:e})=>{this.emitProgress(t,e)}),a.send((t,e)=>{if(this.s3Upload=null,t)this.emitError(t);else{const t=e&&e.Location?e.Location:null;this.emitSuccess(t,{response:{responseText:JSON.stringify(e),headers:{"content-type":"application/json"}}})}this.cleanUp()})}uploadB2(){if(!this.options.b2)return void this.emitError(new Error("The B2 client is not configured on this companion instance."));const t=this.options.metadata.filename||e.basename(this.path),s=this.options.size,i=this.options.b2,o=i.client,r=i.options;this._b2EndpointPool||(this._b2EndpointPool=o.createEndpointPool(r.bucket));const a=o.upload({bucketName:r.bucket,path:this.path,fileName:r.getPath(null,t),fileSize:s,stream:this.beginTailReadStream(),endpointPool:this._b2EndpointPool});this.b2Upload=a,a.onUploadProgress=(({loaded:t,total:e})=>{this.emitProgress(t,e)}),a.send((t,e)=>{this.b2Upload=null,t?this.emitError(t):this.emitSuccess("?",{response:{responseText:JSON.stringify(e),headers:{"content-type":"application/json"}}}),this.cleanUp()})}}b.FILE_NAME_PREFIX="uppy-file",b.STORAGE_PREFIX="companion",module.exports=b;
},{"./emitter":"AtwR","./helpers/utils":"VHJa","./logger":"J3iG","./header-blacklist":"uoOB","./redis":"jBoH"}],"V37X":[function(require,module,exports) {
const e=require("../Uploader"),o=require("../logger");function n(n,r,t){const i=n.params.providerName,s=n.params.id,d=n.companion.providerTokens[i],u=n.companion.provider;u.size({id:s,token:d,query:n.query},(i,a)=>{if(i)return i.isAuthError?r.sendStatus(401):t(i);if(!a)return o.error("unable to determine file size","controller.get.provider.size",n.id),r.status(400).json({error:"unable to determine file size"});o.debug("Instantiating uploader.",null,n.id);const l=new e(e.reqToOptions(n,a));if(l.hasError()){const e=l.getResponse();return void r.status(e.status).json(e.body)}o.debug("Waiting for socket connection before beginning remote download.",null,n.id),l.onSocketReady(()=>{o.debug("Socket connection received. Starting remote download.",null,n.id),u.download({id:s,token:d,query:n.query},l.handleChunk.bind(l))});const c=l.getResponse();r.status(c.status).json(c.body)})}module.exports=n;
},{"../Uploader":"IfnG","../logger":"J3iG"}],"jRsx":[function(require,module,exports) {
function o(o,n,r){const e=o.params.providerName,i=o.params.id,a=o.companion.providerTokens[e];o.companion.provider.thumbnail({id:i,token:a},(o,e)=>{o&&(o.isAuthError?n.sendStatus(401):r(o)),e?e.pipe(n):n.sendStatus(404)})}module.exports=o;
},{}],"JfJq":[function(require,module,exports) {
function o({query:o,params:r,companion:e},n,i){const s=r.providerName,t=e.providerTokens[s];e.provider.list({companion:e,token:t,directory:r.id,query:o},(o,r)=>o?o.isAuthError?n.sendStatus(401):i(o):n.json(r))}module.exports=o;
},{}],"u3CS":[function(require,module,exports) {
const o=require("../helpers/jwt");function n(n,e,r){const s=()=>{n.session.grant&&(n.session.grant.state=null,n.session.grant.dynamic=null)},i=n.params.providerName,a=n.companion.providerTokens?n.companion.providerTokens[i]:null;a?n.companion.provider.logout({token:a},(a,t)=>{if(a)return r(a);delete n.companion.providerTokens[i],o.removeFromCookies(e,n.companion.options,n.companion.provider.authProviderName),s(),e.json(Object.assign({ok:!0},t))}):(s(),e.json({ok:!0,revoked:!1}))}module.exports=n;
},{"../helpers/jwt":"tnRk"}],"Qo6e":[function(require,module,exports) {
const e=require("../helpers/oauth-state"),o=require("atob");module.exports=function(t,n){const a=t.companion.options.secret;let i=e.generateState(a);if(t.query.state){const n=JSON.parse(o(t.query.state));i=e.addToState(i,n,a)}t.companion.options.server.oauthDomain&&(i=e.addToState(i,{companionInstance:t.companion.buildURL("",!0)},a)),t.companion.clientVersion&&(i=e.addToState(i,{clientVersion:t.companion.clientVersion},a)),n.redirect(t.companion.buildURL(`/connect/${t.companion.provider.authProvider}?state=${i}`,!0))};
},{"../helpers/oauth-state":"ONoK"}],"GAta":[function(require,module,exports) {
const e=require("querystring"),t=require("url").parse,r=require("../helpers/utils"),s=r.hasMatch,n=require("../helpers/oauth-state");module.exports=function(r,o){if(!r.query.state)return o.status(400).send("Cannot find state param in reques");const a=n.getFromState(r.query.state,"companionInstance",r.companion.options.secret),i=t(a).host;if(s(i,r.companion.options.server.validHosts)){const t=`${a}/connect/${r.companion.provider.authProvider}/callback?${e.stringify(r.query)}`;return o.redirect(t)}o.status(400).send("Invalid Host in state")};
},{"../helpers/utils":"VHJa","../helpers/oauth-state":"ONoK"}],"b0al":[function(require,module,exports) {
module.exports={callback:require("./callback"),sendToken:require("./send-token"),get:require("./get"),thumbnail:require("./thumbnail"),list:require("./list"),logout:require("./logout"),connect:require("./connect"),redirect:require("./oauth-redirect")};
},{"./callback":"uLtQ","./send-token":"rH3w","./get":"V37X","./thumbnail":"jRsx","./list":"JfJq","./logout":"u3CS","./connect":"Qo6e","./oauth-redirect":"GAta"}],"vdh2":[function(require,module,exports) {
const e=require("express").Router,t=require("ms");function r(e){return e&&"object"==typeof e&&"number"==typeof e.PartNumber&&"string"==typeof e.ETag}module.exports=function(a){if("string"!=typeof a.acl)throw new TypeError("s3: The `acl` option must be a string");if("function"!=typeof a.getKey)throw new TypeError("s3: The `getKey` option must be a function");return e().get("/params",function(e,r,o){const s=e.companion.s3Client,n=e.query.metadata||{},u=a.getKey(e,e.query.filename,n);if("string"!=typeof u)return r.status(500).json({error:"s3: filename returned from `getKey` must be a string"});const p={acl:a.acl,key:u,success_action_status:"201","content-type":e.query.type};Object.keys(n).forEach(e=>{p[`x-amz-meta-${e}`]=n[e]}),s.createPresignedPost({Bucket:a.bucket,Expires:t("5 minutes")/1e3,Fields:p,Conditions:a.conditions},(e,t)=>{e?o(e):r.json({method:"post",url:t.url,fields:t.fields})})}).post("/multipart",function(e,r,o){const s=e.companion.s3Client,n=a.getKey(e,e.body.filename,e.body.metadata||{}),u=e.body,p=u.type,i=u.metadata;return"string"!=typeof n?r.status(500).json({error:"s3: filename returned from `getKey` must be a string"}):"string"!=typeof p?r.status(400).json({error:"s3: content type must be a string"}):void s.createMultipartUpload({Bucket:a.bucket,Key:n,ACL:a.acl,ContentType:p,Metadata:i,Expires:t("5 minutes")/1e3},(e,t)=>{e?o(e):r.json({key:t.Key,uploadId:t.UploadId})})}).get("/multipart/:uploadId",function(e,t,r){const o=e.companion.s3Client,s=e.params.uploadId,n=e.query.key;if("string"!=typeof n)return t.status(400).json({error:'s3: the object key must be passed as a query parameter. For example: "?key=abc.jpg"'});let u=[];!function e(p){o.listParts({Bucket:a.bucket,Key:n,UploadId:s,PartNumberMarker:p},(a,o)=>{a?r(a):(u=u.concat(o.Parts),o.IsTruncated?e(o.NextPartNumberMarker):t.json(u))})}(0)}).get("/multipart/:uploadId/:partNumber",function(e,r,o){const s=e.companion.s3Client,n=e.params,u=n.uploadId,p=n.partNumber,i=e.query.key;return"string"!=typeof i?r.status(400).json({error:'s3: the object key must be passed as a query parameter. For example: "?key=abc.jpg"'}):parseInt(p,10)?void s.getSignedUrl("uploadPart",{Bucket:a.bucket,Key:i,UploadId:u,PartNumber:p,Body:"",Expires:t("5 minutes")/1e3},(e,t)=>{e?o(e):r.json({url:t})}):r.status(400).json({error:"s3: the part number must be a number between 1 and 10000."})}).post("/multipart/:uploadId/complete",function(e,t,o){const s=e.companion.s3Client,n=e.params.uploadId,u=e.query.key,p=e.body.parts;return"string"!=typeof u?t.status(400).json({error:'s3: the object key must be passed as a query parameter. For example: "?key=abc.jpg"'}):Array.isArray(p)&&p.every(r)?void s.completeMultipartUpload({Bucket:a.bucket,Key:u,UploadId:n,MultipartUpload:{Parts:p}},(e,r)=>{e?o(e):t.json({location:r.Location})}):t.status(400).json({error:"s3: `parts` must be an array of {ETag, PartNumber} objects."})}).delete("/multipart/:uploadId",function(e,t,r){const o=e.companion.s3Client,s=e.params.uploadId,n=e.query.key;if("string"!=typeof n)return t.status(400).json({error:'s3: the object key must be passed as a query parameter. For example: "?key=abc.jpg"'});o.abortMultipartUpload({Bucket:a.bucket,Key:n,UploadId:s},(e,a)=>{e?r(e):t.json({})})})};
},{}],"DBwS":[function(require,module,exports) {
const t=require("express").Router;module.exports=function(e){if("function"!=typeof e.getPath)throw new TypeError("b2: the `getPath` option must be a function");return t().get("/config",function(t,e,n){t.uppy.b2Client.preauth().then(t=>{const n=t.recommendedPartSize,a=t.absoluteMinimumPartSize;e.json({recommendedPartSize:n,absoluteMinimumPartSize:a})}).catch(t=>n(t))}).get("/endpoint",function(t,n,a){const r=t.uppy.b2Client;return r.getCachedBucket(e.bucket).then(({bucketId:t})=>r.getUploadUrl({bucketId:t}).then(t=>{const e=t.data,a=e.authorizationToken,r=e.uploadUrl;n.json({authorizationToken:a,uploadUrl:r})}).catch(t=>a(t)))}).post("/multipart",function(t,n,a){const r=t.uppy.b2Client,o=e.getPath(t,t.body.filename),i=t.body.type;return"string"!=typeof o?n.status(500).json({error:"b2: filename returned from `getPath` must be a string"}):"string"!=typeof i?n.status(400).json({error:"b2: content type must be a string"}):r.getCachedBucket(e.bucket).then(({bucketId:t})=>r.startLargeFile({bucketId:t,fileName:o,contentType:i})).then(t=>({fileId:t.data.fileId})).then(t=>{n.json(t)}).catch(t=>a(t))}).get("/multipart/:fileId/endpoint",function(t,e,n){const a=t.uppy.b2Client,r=t.params.fileId;a.getUploadPartUrl({fileId:r}).then(t=>e.json(t.data)).catch(t=>n(t))}).get("/multipart/:fileId",function(t,e,n){const a=t.uppy.b2Client,r=t.params.fileId,o=(t=[],e)=>{const n={fileId:r,maxPartCount:1e3};return e&&(n.nextPartNumber=e),a.listParts(n).then(({data:e})=>{const n=[...t,...(e.parts||[]).map(t=>({PartNumber:t.partNumber,Size:t.contentLength}))];return e.nextPartNumber?o(n,e.nextPartNumber):Promise.resolve(n)})};o().then(t=>e.json({parts:t})).catch(t=>n(t))}).post("/multipart/:fileId/complete",function(t,e,n){const a=t.uppy.b2Client,r=t.body.partSha1Array,o=t.params.fileId;if(void 0===r||"number"!=typeof r.length)return e.status(400).json({error:"b2: partSha1Array array not found"});a.finishLargeFile({fileId:o,partSha1Array:r}).then(({data:t})=>e.json(t)).catch(t=>n(t))}).delete("/multipart/:fileId",function(t,e,n){const a=t.uppy.b2Client,r=t.params.fileId;a.cancelLargeFile({fileId:r}).then(({data:t})=>e.json({fileId:t.fileId,fileName:t.fileName})).catch(t=>n(t))})};
},{}],"J9Xo":[function(require,module,exports) {
const e=require("stream").Writable,t=require("crypto"),n=require("fd-slicer"),r=require("fs"),i=require("./logger"),o=1e4;function s(e){let t=e||0;return(e=0)=>t+=e}function a(e,t=[],n=5){return e(...t).catch(r=>n>0?a(e,t,n-1):Promise.reject(r))}class l{constructor(e,t){this.options=t,this.client=e,this.onUploadProgress=(({total:e,loaded:t})=>{})}getOptimalPartSize(e){return this.client.preauth().then(({recommendedPartSize:t})=>Math.min(Math.max(t,Math.ceil(e/o)),e))}getBucketId(e){return this.client.getCachedBucket(e).then(({bucketId:e})=>e)}send(e){return Promise.all([this.getOptimalPartSize(this.options.fileSize),this.getBucketId(this.options.bucketName)]).then(([e,t])=>{const n=this.options.fileSize,r=this.createProgressReporter(n);return e<n?this._sendMultipart(e,t,r):this._sendSingle(e,t,r)}).then(t=>e(null,t)).catch(t=>{e(t)})}createProgressReporter(e){const t=s(0);return{send:n=>{this.onUploadProgress({loaded:t(n),total:e})}}}_sendSingle(e,t,n){return a(()=>{const t=this.options,r=t.fileName,i=t.fileSize,o=t.stream,s=t.path,a=t.endpointPool,l=this.client,h=[];let c,d;const p={fileId:null,fileName:r,fileSize:i,client:l,endpointPool:a,partSize:e,path:s,progressReporter:n,handleSent:(e,t)=>{h[e.id]={hash:e.hash},d=t,c=t.fileId}};return new Promise((e,t)=>{try{const r=u(p);o.pipe(r),r.on("finish",()=>{e({chunks:h,fileId:c,data:d})})}catch(n){t(n)}})})}_sendMultipart(e,t,n){const r=t=>{const r=this.options,i=r.fileName,o=r.fileSize,s=r.stream,a=r.path,l=r.endpointPool,h=this.client,c=t.fileId,d=[],p={fileId:c,fileName:i,fileSize:o,client:h,endpointPool:l,partSize:e,path:a,progressReporter:n,handleSent:(e,t)=>{d[e.id]={hash:e.hash}}};return new Promise((e,t)=>{try{const r=u(p);s.pipe(r),r.on("finish",()=>{e({chunks:d,fileId:c})})}catch(n){t(n)}})},i=(e,t)=>{const n=t.chunks,r=t.fileId,i=n.map(({hash:e})=>e);return this.client.finishLargeFile({fileId:r,partSha1Array:i}).then(({data:e})=>({chunks:n,data:e,fileId:r}))};return a(()=>{const e=this.options.fileName;return this.client.startLargeFile({bucketId:t,fileName:e}).then(({data:e})=>e)}).then(e=>r(e).then(t=>a(i,[e,t]))).catch(e=>{throw e})}}function h(e){return new Promise((t,i)=>{r.open(e,"r",(e,r)=>{e&&i(e);const o=n.createFromFd(r);t({slicer:o,fd:r})})})}function c(e,n,r){const i=t.createHash("sha1");return i.setEncoding("hex"),new Promise((t,o)=>{e.createReadStream({start:n,end:r}).on("end",()=>{i.end();const e=i.read();t(e)}).pipe(i)})}function d(e){return new Promise((t,n)=>{r.close(e,r=>{r?n(r):t(e)})})}function u(t){const n=t.fileName,r=t.fileSize,o=t.partSize,s=t.path,l=t.endpointPool,u=t.fileId,p=t.client,f=t.progressReporter,m=t.connections,g=void 0===m?3:m,P=!!u,S=h(s),z=[],I=[];let k=0,N=0,w=0;const R=()=>{if(I.length&&z.length<g){I.shift()()}},b=e=>{const r=k-N,o=k,s=w++,h=o-r;N=0;const d=(e,t)=>l.acquire(u).then(a=>{const c=a.authorizationToken,d=a.uploadUrl,u=t.createReadStream({start:r,end:o});let f=null;return(f=P?p.uploadPart({uploadUrl:d,uploadAuthToken:c,data:u,hash:e,contentLength:h,partNumber:s+1}):p.uploadFile({uploadUrl:d,uploadAuthToken:c,fileName:n,data:u,hash:e,contentLength:h})).then(()=>{l.release(a)}),f.catch(e=>{i.error(e,"uploader.b2.error"),u.destroy()}),f}),f=Promise.all([(()=>S.then(({slicer:e})=>c(e,r,o)))(),S]).then(([e,{slicer:n}])=>a(d,[e,n]).then(({data:n})=>(t.handleSent&&t.handleSent({id:s,hash:e},n),n))).then(e=>{const t=z.indexOf(f);return z.splice(t,1),R(),e});return z.push(f),f};let q=0;return new e({write:function(e,t,n){const i=e.length;let s=i;for(;s>0;){const e=Math.min(s,o-N);s-=e,k+=e,(N+=e)===o&&b()}var a;a=(()=>{f.send(i),q+=i,n(),q===r&&this.end()}),I.push(a),R()},final:function(e){N>0&&b(),Promise.all(z).then(()=>S.then(({fd:e})=>e)).then(e=>d(e)).then(t=>{e()}).catch(t=>e(t))}})}module.exports=l;
},{"./logger":"J3iG"}],"OUmk":[function(require,module,exports) {
const t=require("backblaze-b2"),e=require("ms"),r=require("./b2stream");function s(t,r=e("30m")){const s=Object.create(null);return e=>{const i=s[e];return i&&i.expiration<Date.now()?i.result:(s[e]={result:t.getBucket({bucketName:e}),expiration:Date.now()+r},s[e].result)}}function i(t,e){const r={default:[]};return{acquire:s=>{if(s){const e=r[s]=r[s]||[];return e.length?Promise.resolve(e.shift()):t.getUploadPartUrl({fileId:s}).then(({data:t})=>t)}{const s=r.default;return s.length?Promise.resolve(s.shift()):t.getCachedBucket(e).then(({bucketId:e})=>t.getUploadUrl({bucketId:e})).then(({data:t})=>t)}},release:t=>{const e=t.fileId;e?(r[e]=r[e]||[],r[e].push(t)):r.default.push(t)},finish:t=>{delete r[t]}}}module.exports=class{constructor(e){this.b2=new t({applicationKeyId:e.key,applicationKey:e.secret,axios:e.axios||{},retry:e.retry}),this._bucketCache=s(this),this.lastAuthResponseData={}}preauth(t){if(this._auth){if(t)return this._auth.then(e=>(e.authorizationToken===t&&delete this._auth,this.preauth()))}else this._auth=this.b2.authorize().then(t=>(this.lastAuthResponseData=t.data,t.data)).catch(t=>(console.log("Error attempting to authorize with B2:"+t),delete this._auth,this.preauth()));return this._auth}request(t,e){return this.preauth(e).then(e=>t().catch(r=>{if(r.response&&401===r.response.status)return this.request(t,e.authorizationToken);throw r}))}startLargeFile(t){return this.request(()=>this.b2.startLargeFile(t))}finishLargeFile(t){return this.request(()=>this.b2.finishLargeFile(t))}getBucket(t){return this.request(()=>this.b2.getBucket(t)).then(e=>{const r=e.data.buckets;if(r&&r.length)return r[0];throw new Error("Unable to find bucket ("+JSON.stringify(t)+")")})}getCachedBucket(t){return this._bucketCache(t)}listParts(t){return this.request(()=>this.b2.listParts(t))}getUploadPartUrl(t){return this.request(()=>this.b2.getUploadPartUrl(t))}getUploadUrl(t){return this.request(()=>this.b2.getUploadUrl(t))}cancelLargeFile(t){return this.request(()=>this.b2.cancelLargeFile(t))}uploadFile(t){return this.request(()=>this.b2.uploadFile(t))}uploadPart(t){return this.request(()=>this.b2.uploadPart(t))}upload(t){return new r(this,t)}createEndpointPool(t){return i(this,t)}};
},{"./b2stream":"J9Xo"}],"Ty5H":[function(require,module,exports) {
const e=require("express").Router,r=require("request"),o=require("../Uploader"),t=require("validator"),n=require("../helpers/utils"),l=require("../logger");module.exports=(()=>e().post("/meta",d).post("/get",i));const d=(e,r)=>{if(l.debug("URL file import handler running",null,e.id),!t.isURL(e.body.url,{require_protocol:!0,require_tld:!e.companion.options.debug}))return l.debug("Invalid request body detected. Exiting url meta handler.",null,e.id),r.status(400).json({error:"Invalid request body"});n.getURLMeta(e.body.url).then(e=>r.json(e)).catch(o=>(l.error(o,"controller.url.meta.error",e.id),r.status(500).json({error:o})))},i=(e,r)=>{l.debug("URL file import handler running",null,e.id),n.getURLMeta(e.body.url).then(({size:t})=>{l.debug("Instantiating uploader.",null,e.id);const n=new o(o.reqToOptions(e,t));if(n.hasError()){const e=n.getResponse();return void r.status(e.status).json(e.body)}l.debug("Waiting for socket connection before beginning remote download.",null,e.id),n.onSocketReady(()=>{l.debug("Socket connection received. Starting remote download.",null,e.id),u(e.body.url,n.handleChunk.bind(n),e.id)});const d=n.getResponse();r.status(d.status).json(d.body)}).catch(o=>{l.error(o,"controller.url.get.error",e.id),r.json({err:o})})},u=(e,o,t)=>{r({uri:e,method:"GET",followAllRedirects:!0}).on("data",o).on("end",()=>o(null)).on("error",e=>l.error(e,"controller.url.download.error",t))};
},{"../Uploader":"IfnG","../helpers/utils":"VHJa","../logger":"J3iG"}],"MXaq":[function(require,module,exports) {
const e=require("node-schedule"),r=require("./Uploader"),o=r.FILE_NAME_PREFIX,n=require("fs"),i=require("path"),s=require("./logger");exports.startCleanUpJob=(r=>{s.info("starting clean up job","jobs.cleanup.start"),e.scheduleJob("0 23 * * *",()=>l(r))});const l=e=>{s.info(`running clean up job for path: ${e}`,"jobs.cleanup.progress.read"),n.readdir(e,(r,l)=>{r?s.error(r,"jobs.cleanup.read.error"):(s.info(`found ${l.length} files`,"jobs.cleanup.files"),l.forEach((r,l)=>{if(!r.startsWith(o))return void s.info(`skipping file ${r}`,"jobs.cleanup.skip");const t=i.join(e,r);n.stat(t,(e,o)=>{if(e)s.error(e,"jobs.cleanup.stat.error");else if(new Date-o.mtime<432e5)return void s.info(`skipping file ${r}`,"jobs.cleanup.skip");s.info(`deleting file ${r}`,"jobs.cleanup.progress.delete"),n.unlink(t,e=>{e&&s.error(e,"jobs.cleanup.delete.error")})})}))})};
},{"./Uploader":"IfnG","./logger":"J3iG"}],"ck9L":[function(require,module,exports) {
const o=require("./helpers/jwt"),e=require("./logger");exports.hasSessionAndProvider=((o,r,n)=>o.session&&o.body?o.companion.provider?n():(e.debug("No provider/provider-handler found. Exiting dispatcher.",null,o.id),r.sendStatus(400)):(e.debug("No session/body attached to req object. Exiting dispatcher.",null,o.id),r.sendStatus(400))),exports.verifyToken=((r,n,i)=>{const t=r.params.providerName,s=o.verifyToken(r.companion.authToken,r.companion.options.secret),a=s.err,p=s.payload;if(a||!p[t])return a&&e.error(a,"token.verify.error",r.id),n.sendStatus(401);r.companion.providerTokens=p,i()}),exports.gentleVerifyToken=((e,r,n)=>{const i=e.params.providerName;if(e.companion.authToken){const r=o.verifyToken(e.companion.authToken,e.companion.options.secret),n=r.err,t=r.payload;!n&&t[i]&&(e.companion.providerTokens=t)}n()}),exports.cookieAuthToken=((o,e,r)=>(o.companion.authToken=o.cookies[`uppyAuthToken--${o.companion.provider.authProvider}`],r()));
},{"./helpers/jwt":"tnRk","./logger":"J3iG"}],"BC0t":[function(require,module,exports) {
const e=require("express"),r=require("grant").express(),o=require("./config/grant")(),s=require("./server/provider"),n=require("./server/controllers"),i=require("./server/controllers/s3"),t=require("./server/controllers/b2"),d=require("./server/b2"),c=require("./server/controllers/url"),a=require("ws").Server,p=require("./server/emitter"),l=require("lodash.merge"),u=require("./server/redis"),v=require("cookie-parser"),g=require("./server/helpers/utils"),m=g.jsonStringify,h=g.getURLBuilder,k=require("./server/jobs"),q=require("express-interceptor"),A=require("./server/logger"),f=require("./server/Uploader"),y=f.STORAGE_PREFIX,b=require("./server/middlewares"),P=require("./server/Uploader"),S=P.shortenToken,w={server:{protocol:"http",path:""},providerOptions:{s3:{acl:"public-read",endpoint:"https://{service}.{region}.amazonaws.com",conditions:[],useAccelerateEndpoint:!1,getKey:(e,r)=>r},b2:{getPath:(e,r)=>r}},debug:!0};module.exports.app=((d={})=>{d=l({},w,d);const a=s.getDefaultProviders(d);s.addProviderOptions(d,o);const g=d.customProviders;g&&s.addCustomProviders(g,a,o),d.redisUrl&&u.client(l({url:d.redisUrl},d.redisOptions||{})),p(d.multipleInstances&&d.redisUrl);const m=e();return m.use(v()),m.use(T),m.use(r(o)),m.use((e,r,o)=>{r.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, DELETE"),r.header("Access-Control-Allow-Headers",["uppy-auth-token","uppy-versions",r.get("Access-Control-Allow-Headers")].join(","));const s=["Access-Control-Allow-Headers"];if(d.sendSelfEndpoint){s.push("i-am");const e=d.server.protocol;r.header("i-am",`${e}://${d.sendSelfEndpoint}`)}r.get("Access-Control-Expose-Headers")&&s.push(r.get("Access-Control-Expose-Headers")),r.header("Access-Control-Expose-Headers",s.join(",")),o()}),m.use("*",O(d)),m.use("/s3",i(d.providerOptions.s3)),m.use("/b2",t(d.providerOptions.b2)),m.use("/url",c()),m.get("/:providerName/callback",b.hasSessionAndProvider,n.callback),m.get("/:providerName/connect",b.hasSessionAndProvider,n.connect),m.get("/:providerName/redirect",b.hasSessionAndProvider,n.redirect),m.get("/:providerName/logout",b.hasSessionAndProvider,b.gentleVerifyToken,n.logout),m.get("/:providerName/send-token",b.hasSessionAndProvider,b.verifyToken,n.sendToken),m.get("/:providerName/list/:id?",b.hasSessionAndProvider,b.verifyToken,n.list),m.post("/:providerName/get/:id",b.hasSessionAndProvider,b.verifyToken,n.get),m.get("/:providerName/thumbnail/:id",b.hasSessionAndProvider,b.cookieAuthToken,b.verifyToken,n.thumbnail),m.param("providerName",s.getProviderMiddleware(a)),"test"!==m.get("env")&&k.startCleanUpJob(d.filePath),m}),module.exports.socket=(e=>{const r=new a({server:e}),o=u.client();r.on("connection",(e,r)=>{const s=r.url.replace(/^.*\/api\//,"");function n(r){e.send(m(r),e=>{e&&A.error(e,"socket.progress.error",S(s))})}A.info(`connection received from ${s}`,"socket.connect"),o&&o.get(`${y}:${s}`,(e,r)=>{if(e&&A.error(e,"socket.redis.error",S(s)),r){const e=JSON.parse(r.toString());e.action&&n(e)}}),p().emit(`connection:${s}`),p().on(s,n),e.on("message",e=>{const r=JSON.parse(e.toString());["pause","resume","cancel"].includes(r.action)&&p().emit(`${r.action}:${s}`)}),e.on("close",()=>{p().removeListener(s,n)})})});const T=q((e,r)=>({isInterceptable:()=>/^\/connect\/\w+\/callback/.test(e.path),intercept:(o,s)=>{if("error=Grant%3A%20missing%20session%20or%20misconfigured%20provider"===o){A.error(`grant.js responded with error: ${o}`,"grant.oauth.error",e.id),r.set("Content-Type","text/plain"),s(["Companion was unable to complete the OAuth process :(","Error: User session is missing or the Provider was misconfigured",e.id?`Request ID: ${e.id}`:""].join("\n"))}else s(o)}})),O=e=>{let r=null;if(e.providerOptions.s3){const o=require("aws-sdk/clients/s3"),s=require("aws-sdk"),n=e.providerOptions.s3;let i;n.key&&n.secret&&(i=new s.Credentials(n.key,n.secret,n.sessionToken)),r=new o({region:n.region,endpoint:n.endpoint,credentials:i,signatureVersion:"v4",useAccelerateEndpoint:n.useAccelerateEndpoint})}let o=null;if(e.providerOptions.b2){const r=e.providerOptions.b2;o=new d(r)}return(s,n,i)=>{const t=s.query.uppyVersions?decodeURIComponent(s.query.uppyVersions):null;s.companion={options:e,s3Client:r,b2Client:o,authToken:s.header("uppy-auth-token")||s.query.uppyAuthToken,clientVersion:s.header("uppy-versions")||t||"1.0.0",buildURL:h(e)},s.uppy=s.companion,i()}};
},{"./config/grant":"qMXF","./server/provider":"szpj","./server/controllers":"b0al","./server/controllers/s3":"vdh2","./server/controllers/b2":"DBwS","./server/b2":"OUmk","./server/controllers/url":"Ty5H","./server/emitter":"AtwR","./server/redis":"jBoH","./server/helpers/utils":"VHJa","./server/jobs":"MXaq","./server/logger":"J3iG","./server/Uploader":"IfnG","./server/middlewares":"ck9L"}]},{},["BC0t"], null)
//# sourceMappingURL=/companion.js.map